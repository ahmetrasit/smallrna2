<div class="modal fade" id="newDatasetModal" tabindex="-1" role="dialog" aria-labelledby="Add New Dataset" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addDatasetTitle">Add New Dataset</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" id="newDatasetModalBody">
        <div class="row d-none" id="fileupload_div">
          <div class="col-md-12 text-center">
            <p class="lead">Upload <b>.fastq.gz files</b></p>
            <div class="input-group mb-3">
              <div class="custom-file">
                <input type="file" class="custom-file-input" id="fileupload" multiple>
                <label class="custom-file-label" for="fileupload">Choose file(s)</label>
              </div>
            </div>
          </div>
        </div>
        <div class="row" id="debarcodingSelection">
          <div onclick="needsDebarcoding()" class="jumbotron col-md-6 bg-white text-center jumbotron-link text-black-50">
            <h1 class="display-5">Needs Debarcoding</h1>
            <p class="lead">Upload FASTQ files</p>
          </div>
          <div onclick="noDebarcoding()" class="jumbotron col-md-6 bg-white text-center jumbotron-link text-black-50">
            <h1 class="display-5">No Need to Debarcode</h1>
            <p class="lead">Use already debarcoded data / files</p>
          </div>
        </div>
        <div class="row d-none" id="new_dataset_info">
          <div class="col-md-12">
            <div class="row">
              <div class="form-group col-md-4">
                <input type="text" name="new_dataset_name" id="new_dataset_name" class="form-control" required autofocus maxlength="128">
                <label class="form-control-placeholder" for="new_dataset_name">Dataset Name</label>
              </div>
              <div class="form-group col-md-8">
                <input name="new_dataset_description" id="new_dataset_description" class="form-control" required/>
                <label class="form-control-placeholder" for="new_dataset_description">Description</label>
              </div>
            </div>
          </div>
        </div>

        <div class="row d-none" id="needsDebarcoding">
            <div class="col-md-12 no-file-uploaded">
                <div class="bg-danger text-white text-center lead rounded">Please upload .fastq.gz file(s) first.</div>
            </div>
            <div class="form-group col-md-12 addBarcodeButton d-none mb-0">
                <button class="btn form-control text-white bg-success" onclick="addBarcodeInput()"><span class="">Add Barcode</span></button>
            </div>

            <div class="input-group-sm col-md-12 addBarcodeButton d-none mb-1 mt-0">
              <div class="input-group-prepend">
                <div class="input-group-text">
                  <input type="checkbox" aria-label="Remove adapters?" name="remove_adapter" checked> <span class="pl-2"> Remove Adapter: </span>
                </div>
              </div>
              <input type="text" class="form-control" aria-label="Adapter sequence" name="adapter_sequence" value="AGATCGGAA" style="text-transform: uppercase">
            </div>


            <div class="col-md-12 barcodeInputs"></div>
        </div>


        <div class="row d-none" id="noDebarcoding">
            <div class="col-md-12 no-file-uploaded">
                <div class=" bg-danger text-white text-center lead rounded">Please upload .fastq.gz file(s) first.</div>
            </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>


<script>


    var emptyFilelist = $('#fileupload').prop('files')
  $('#newDatasetModal').on('hidden.bs.modal', function (e) {
      $('#debarcodingSelection').addClass('d-flex')
      $('#needsDebarcoding').removeClass('d-flex').addClass('d-none')
      $('#noDebarcoding').removeClass('d-flex').addClass('d-none')
      $('#new_dataset_info').removeClass('d-flex').addClass('d-none')
      $('#fileupload_div').removeClass('d-flex').addClass('d-none')
      $('.addBarcodeButton').removeClass('d-flex').addClass('d-none')
      d3.selectAll('.noDebarcodingFile').remove()
      d3.selectAll('.barcodeInput').remove()
      $('.custom-file-label').text('Choose file(s)')
      $('#fileupload').val('');
      $('.no-file-uploaded').removeClass('d-none').addClass('d-block')
  })

  function needsDebarcoding() {
      $('#debarcodingSelection').removeClass('d-flex').addClass('d-none')
      $('#needsDebarcoding').addClass('d-flex')
      $('#new_dataset_info').addClass('d-flex')
      new_dataset_focus = 'needs debarcoding'
      $('#fileupload_div').addClass('d-flex')
  }

  function noDebarcoding() {
      $('#debarcodingSelection').removeClass('d-flex').addClass('d-none')
      $('#noDebarcoding').addClass('d-flex')
      $('#new_dataset_info').addClass('d-flex')
      new_dataset_focus = 'no debarcoding'
      $('#fileupload_div').addClass('d-flex')
  }

  var new_dataset_focus = ''
  $('#fileupload').change(function(d){
      var fileNames = [];
      var fileListTemp= $('#fileupload').prop('files')
      for(var i = 0; i<fileListTemp['length']; i++){
          //console.log(fileListTemp[i].name, fileListTemp[i].type)
          if(fileListTemp[i].name.match(/.fastq.gz$/)){
              //console.log('match', fileListTemp[i].name)
              fileNames.push(fileListTemp[i].name)
          }
      }
      if (fileNames.length > 0){
        $('.custom-file-label').text(fileNames.length + ' file(s) selected')
        if (new_dataset_focus === 'needs debarcoding'){
            addBarcodeInput()
        } else {
            populateNoDebarcodingFileList(fileNames)
        }
        $('.barcodeInput').removeClass('d-none').addClass('d-flex')
        $('.no-file-uploaded').removeClass('d-block').addClass('d-none')
        $('.addBarcodeButton').removeClass('d-none').addClass('d-flex')
      } else {
          d3.selectAll('.noDebarcodingFile').remove()
          $('.custom-file-label').text('Choose file(s)')
          $('#barcodes').removeClass('d-flex').addClass('d-none')
          $('.no-file-uploaded').removeClass('d-none').addClass('d-block')
          $('.addBarcodeButton').removeClass('d-flex').addClass('d-none')
          $('.barcodeInput').removeClass('d-flex').addClass('d-none')
          d3.selectAll('div.barcodeInput').remove()
      }
  })


    function populateNoDebarcodingFileList(filelist) {
        d3.selectAll('.noDebarcodingFile').remove()

        var file_definitions = d3.select('#newDatasetModalBody').selectAll('div.noDebarcodingFile').data(filelist).enter()
            .append('div').attr('class', 'form-row noDebarcodingFile row-hover p-1 m-1 rounded align-items-center')

        file_definitions.append('div').attr('class', 'form-group-sm col-md-3')
            .append('input').attr('type', 'text').attr('name', function(d,i){return 'noDebarcoding_sampleName_'+i})
            .attr('id', function(d,i){return 'noDebarcoding_sampleName_'+i})
            .attr('class', 'form-control').attr('maxlength' , '32')
            .attr('placeholder', 'Sample Name')
        file_definitions.append('div')
            .attr('id', function(d,i){return 'noDebarcoding_fileName_'+i})
            .attr('class', 'form-group-sm col-md-9 font-italic border-bottom')
            .html(function(d,i){return d})
    }


    function fillBarcodeSeq() {
        var select = document.getElementById(this.id)

        document.getElementById(this.id.replace('_select', '')).value = select.options[select.selectedIndex].value
    }

  function addBarcodeInput() {
        var barcode_id;
        var latest_barcode_id = Math.max(...$('.barcodeInput').map(function (){return parseInt(this.id.replace('barcode_', '')) }).toArray())
        console.log(latest_barcode_id)
        if(latest_barcode_id>0){
            barcode_id = latest_barcode_id + 1
        }else{
            barcode_id = 1
        }

        var curr_main = d3.select('div.barcodeInputs').append('div')
            .attr('class', 'barcodeInput row').attr('id', 'barcode_'+barcode_id)

        var barcodeList = [
            {'id':'barcode #', 'seq':''},
            {'id':'168', 'seq':'ATCACGCA'},
            {'id':'169', 'seq':'CGATGTCT'},
            {'id':'170', 'seq':'TTAGGCGT'},
            {'id':'171', 'seq':'TGACCACC'},
            {'id':'172', 'seq':'ACAGTGCG'},
            {'id':'173', 'seq':'GCCAATTT'},
            {'id':'174', 'seq':'CAGATCGG'},
            {'id':'175', 'seq':'ACTTGATG'},
            {'id':'176', 'seq':'GATCAGTT'}
        ]
        var barcode_dropdown = curr_main.append('div').attr('class', 'col-md-6 mt-2').append('div').attr('class', 'input-group')
        var barcode_prepend = barcode_dropdown.append('div').attr('class', 'input-group-prepend form-group')
        barcode_prepend.append('select').on('change', fillBarcodeSeq)
            .attr('class', 'form-control')
            .attr('id', 'new_barcode_select_'+barcode_id)
            .selectAll('option').data(barcodeList).enter()
            .append('option')
                .text( function(d){return d['id']})
                .attr('value', function(d,i){return d['seq']})
        barcode_dropdown.append('div').attr('class', 'form-control text-center bg-light justify-content-center').html('or')

        var barcode_input = barcode_dropdown.append('div').attr('class', 'form-group')
        barcode_input.append('input').attr('class', 'form-control').attr('type', 'text').attr('id', 'new_barcode_'+barcode_id)
            .attr('name', 'new_barcode'+barcode_id).attr('required', true).attr('autofocus', true).attr('max_length', '128')
            .style('text-transform', 'uppercase')
        barcode_input.append('label').attr('class', 'form-control-placeholder text-muted').attr('for', 'new_barcode'+barcode_id).text('Barcode Sequence')


        //var or_text = curr_main.append('div').attr('class', 'col-md-1 m-0 p-0')
        //    .append('div').attr('class', 'lead text-center').html('or')
/*
        var barcode_input = curr_main.append('div').attr('class', 'form-group col-md-3')
        barcode_input.append('input').attr('class', 'form-control').attr('type', 'text').attr('id', 'new_barcode'+barcode_id)
            .attr('name', 'new_barcode'+barcode_id).attr('required', true).attr('autofocus', true).attr('max_length', '128')
            .style('text-transform', 'uppercase')
        barcode_input.append('label').attr('class', 'form-control-placeholder text-muted').attr('for', 'new_barcode'+barcode_id).text('Barcode Sequence')

 */
        var sample_input = curr_main.append('div').attr('class', 'form-group col-md-5  mt-2')
        sample_input.append('input').attr('class', 'form-control').attr('type', 'text').attr('id', 'new_sample'+barcode_id)
            .attr('name', 'new_sample'+barcode_id).attr('required', true).attr('autofocus', true).attr('max_length', '128')
        sample_input.append('label').attr('class', 'form-control-placeholder text-muted').attr('for', 'new_sample'+barcode_id).text('Sample Name')

        curr_main.append('div').attr('class', 'form-group col-md-1  mt-2')
            .append('button')
                .attr('onclick', 'removeBarcode(' + barcode_id + ')')
                .attr('class', 'btn form-control text-white bg-danger')
                .append('span').html('-')

    }

    function removeBarcode(barcode_id){
        d3.select('#barcode_'+barcode_id).remove()
        if($('.barcodeInput').length == 0){
            addBarcodeInput()
        }
    }
</script>

